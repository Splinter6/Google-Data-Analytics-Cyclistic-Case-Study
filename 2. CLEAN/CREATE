WITH DurationBuckets AS (
    SELECT
        member_casual,
        CASE
            WHEN dur_m <= 5 THEN '0-5 minutes'
            WHEN dur_m BETWEEN 6 AND 10 THEN '6-10 minutes'
            WHEN dur_m BETWEEN 11 AND 15 THEN '11-15 minutes'
            WHEN dur_m BETWEEN 16 AND 20 THEN '16-20 minutes'
            WHEN dur_m BETWEEN 21 AND 30 THEN '21-30 minutes'
            WHEN dur_m BETWEEN 31 AND 45 THEN '31-45 minutes'
            WHEN dur_m BETWEEN 46 AND 60 THEN '46-60 minutes'
            ELSE 'Over 60 minutes'
        END AS duration_range,
        COUNT(*) AS ride_count,
        CASE
            WHEN dur_m <= 5 THEN 1
            WHEN dur_m BETWEEN 6 AND 10 THEN 2
            WHEN dur_m BETWEEN 11 AND 15 THEN 3
            WHEN dur_m BETWEEN 16 AND 20 THEN 4
            WHEN dur_m BETWEEN 21 AND 30 THEN 5
            WHEN dur_m BETWEEN 31 AND 45 THEN 6
            WHEN dur_m BETWEEN 46 AND 60 THEN 7
            ELSE 8
        END AS ordering
    FROM
        `cyclistic-data-strategy.555.ALLCLEAN`
    GROUP BY
        member_casual,
        duration_range,
        ordering
)
SELECT
    member_casual,
    duration_range,
    ride_count,
    ROUND((ride_count / SUM(ride_count) OVER (PARTITION BY member_casual)) * 100, 2) AS percentage_of_total
FROM
    DurationBuckets
ORDER BY
    member_casual,
    ordering;

